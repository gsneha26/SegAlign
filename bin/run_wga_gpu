#!/bin/bash

#custom error code
#4 - file not found
#5 - no permissions to create directory

set -e

optionalArguments=""

args=("$@")
for ((i=2; i < $#; i++))
    {
        optionalArguments="$optionalArguments ${args[$i]}"
    }

if [ $# -eq 1 ] || [ $# -eq 0 ] 
then
	wga $1
else
	refPath=$(readlink -f $1)
	queryPath=$(readlink -f $2)

  if [ ! -f "$refPath" ]; then
      echo "target file $refPath does not exist"
      (exit 4)
  fi

  if [ ! -f "$queryPath" ]; then
      echo "query file $queryPath does not exist"
      (exit 4)
  fi

	refChr=$(grep ">" $refPath | wc -l)
	queryChr=$(grep ">" $queryPath | wc -l)
	
  if [ ! -w $PWD ]; then
      echo "Cannot create output directory in $PWD because of permissions"
      (exit 5)
  fi

  FOLDER1=$PWD/output_$RANDOM
  mkdir -p $FOLDER1

  if [ ! -w $FOLDER1 ]; then
      echo "Cannot create data directory in $FOLDER1 because of permissions"
      (exit 5)
  fi

	FOLDER=$FOLDER1/data_$RANDOM/
	mkdir -p $FOLDER
	
	1>&2 echo "Splitting reference chromosome"
	cd $FOLDER
	mkdir -p "ref"
	cd "ref"
	faSplit sequence $refPath $refChr ref

	1>&2 echo "Converting chromosome wise fasta to 2bit format"
	for i in *;
	do
	    echo "faToTwoBit $i $(basename -s .fa $i).2bit" >> cmd.sh
	done
  parallel --jobs=$(nproc) < cmd.sh
	rm cmd.sh *.fa
	
	1>&2 echo "Splitting query chromosome"
	cd $FOLDER
	mkdir -p "query"
	cd "query"
	faSplit sequence $queryPath $queryChr query

	1>&2 echo "Converting chromosome wise fasta to 2bit format"
	for i in *;
	do
	    echo "faToTwoBit $i $(basename -s .fa $i).2bit" >> cmd.sh
	done
  parallel --jobs=$(nproc) < cmd.sh
	rm cmd.sh *.fa
	
  1>&2 echo "Executing: \"wga $refPath $queryPath $FOLDER $optionalArguments\""
  time {
  pids=""
  cd $FOLDER1
  while IFS= read -r line; do eval "$line" & pids="$pids $!"; done < <(stdbuf -oL wga $refPath $queryPath $FOLDER $optionalArguments )
      wait $pids
  }

  rm *.segments
  rm -rf $FOLDER
  cat tmp*
  rm -rf $FOLDER1
fi
